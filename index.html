<!-- /index.html – StudyMate Light (file tổng hợp) -->
<!doctype html>
<html lang="vi" class="h-full">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>StudyMate Light – File tổng hợp</title>
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React 18 UMD + ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Recharts UMD -->
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
  </head>
  <body class="h-full bg-gray-50 text-gray-900">
    <div id="root" class="min-h-full p-4 md:p-6"></div>

    <script>
      // Chỉ giải thích "tại sao": clamp để tránh số liệu vượt range khi mô phỏng
      function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }
      const h = React.createElement;
      const { useState, useEffect, useMemo, useRef } = React;
      const { ResponsiveContainer, LineChart, Line, CartesianGrid, XAxis, YAxis, Tooltip, Legend, ReferenceLine } = Recharts;

      function App(){
        // --- Sensor state ---
        const [lux, setLux] = useState(520);
        const [dist, setDist] = useState(45);
        const [temp, setTemp] = useState(26);
        const [hum, setHum] = useState(55);
        // --- LED/Control state ---
        const [led, setLed] = useState(() => Number(localStorage.getItem('led') || 50));
        const [autoLed, setAutoLed] = useState(() => localStorage.getItem('autoLed') !== 'false');
        const [targetLuxMin, setTargetLuxMin] = useState(() => Number(localStorage.getItem('tLuxMin') || 400));
        const [targetLuxMax, setTargetLuxMax] = useState(() => Number(localStorage.getItem('tLuxMax') || 600));
        const [simRunning, setSimRunning] = useState(true);

        // --- Pomodoro ---
        const [focusMin, setFocusMin] = useState(() => Number(localStorage.getItem('focusMin') || 25));
        const [breakMin, setBreakMin] = useState(() => Number(localStorage.getItem('breakMin') || 5));
        const [mode, setMode] = useState('focus');
        const [remain, setRemain] = useState(() => focusMin * 60);
        const [timerRunning, setTimerRunning] = useState(true);

        // --- History for chart ---
        const [history, setHistory] = useState([]);

        // Persist critical settings across reloads
        useEffect(() => localStorage.setItem('autoLed', String(autoLed)), [autoLed]);
        useEffect(() => localStorage.setItem('led', String(led)), [led]);
        useEffect(() => localStorage.setItem('tLuxMin', String(targetLuxMin)), [targetLuxMin]);
        useEffect(() => localStorage.setItem('tLuxMax', String(targetLuxMax)), [targetLuxMax]);
        useEffect(() => localStorage.setItem('focusMin', String(focusMin)), [focusMin]);
        useEffect(() => localStorage.setItem('breakMin', String(breakMin)), [breakMin]);

        // Sensor + timer simulation tick (1s)
        useEffect(() => {
          if(!simRunning && !timerRunning) return; // tránh setInterval không cần thiết
          const id = setInterval(() => {
            if (simRunning) {
              setLux(prev => clamp(prev + (Math.random()*40 - 20), 200, 800));
              setDist(prev => clamp(prev + (Math.random()*6 - 3), 20, 90));
              setTemp(prev => clamp(prev + (Math.random()*2 - 1), 20, 33));
              setHum(prev => clamp(prev + (Math.random()*4 - 2), 30, 75));
              setHistory(hh => {
                const now = new Date();
                const item = { t: now.toLocaleTimeString(), lux, dist, temp, hum, led };
                const next = [...hh, item];
                return next.length > 120 ? next.slice(-120) : next;
              });
              // Điều khiển LED tự động kiểu đơn giản để minh hoạ
              if (autoLed) {
                setLed(prev => {
                  let next = prev;
                  if (lux < targetLuxMin) next = prev + 5; else if (lux > targetLuxMax) next = prev - 5;
                  return clamp(Math.round(next), 0, 100);
                });
              }
            }

            if (timerRunning) {
              setRemain(r => {
                if (r > 0) return r - 1;
                // chuyển pha khi về 0
                const nextMode = mode === 'focus' ? 'break' : 'focus';
                setMode(nextMode);
                return (nextMode === 'focus' ? focusMin : breakMin) * 60;
              });
            }
          }, 1000);
          return () => clearInterval(id);
        }, [simRunning, timerRunning, lux, dist, temp, hum, autoLed, targetLuxMin, targetLuxMax, mode, focusMin, breakMin, led]);

        const timeFmt = (sec) => `${Math.floor(sec/60)}:${String(sec%60).padStart(2,'0')}`;

        function resetTimer() {
          setMode('focus');
          setRemain(focusMin * 60);
          setTimerRunning(false);
        }

        function exportData(){
          // Dễ chia sẻ khi làm KHKT
          const blob = new Blob([JSON.stringify({ history }, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = 'studymate-data.json'; a.click();
          URL.revokeObjectURL(url);
        }

        function importData(file){
          const reader = new FileReader();
          reader.onload = () => {
            try {
              const parsed = JSON.parse(reader.result);
              if (Array.isArray(parsed.history)) setHistory(parsed.history.slice(-120));
            } catch(e){ alert('File không hợp lệ'); }
          };
          reader.readAsText(file);
        }

        // --- UI ---
        return h('div', { className: 'space-y-6 max-w-6xl mx-auto' }, [
          // Header
          h('header', { className: 'flex items-center justify-between' }, [
            h('h1', { className: 'text-2xl md:text-3xl font-bold' }, 'StudyMate Light – Dashboard tổng hợp'),
            h('div', { className: 'flex items-center gap-2' }, [
              h('button', {
                className: 'px-3 py-2 rounded-lg border bg-white hover:bg-gray-50',
                onClick: () => setSimRunning(s => !s)
              }, simRunning ? 'Tạm dừng mô phỏng' : 'Tiếp tục mô phỏng'),
              h('button', {
                className: 'px-3 py-2 rounded-lg border bg-white hover:bg-gray-50',
                onClick: exportData
              }, 'Xuất dữ liệu')
            ])
          ]),

          // KPI Cards
          h('div', { className: 'grid grid-cols-2 md:grid-cols-6 gap-4' }, [
            InfoCard('Độ rọi (Lux)', lux.toFixed(0), `${targetLuxMin}-${targetLuxMax}`),
            InfoCard('LED (%)', String(led), autoLed ? 'auto' : 'thủ công'),
            InfoCard('Nhiệt độ (°C)', temp.toFixed(1), '22–28'),
            InfoCard('Độ ẩm (%)', hum.toFixed(0), '40–60'),
            InfoCard('Khoảng cách (cm)', dist.toFixed(0), '35–60'),
            InfoCard('Pomodoro', timeFmt(remain), mode === 'focus' ? 'Đang tập trung' : 'Giải lao')
          ]),

          // Controls row
          h('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-4' }, [
            // LED control
            h('div', { className: 'p-4 bg-white rounded-xl border' }, [
              h('div', { className: 'font-semibold mb-2' }, 'Điều khiển đèn LED'),
              h('label', { className: 'flex items-center gap-2 mb-3' }, [
                h('input', {
                  type: 'checkbox', checked: autoLed,
                  onChange: e => setAutoLed(e.target.checked)
                }),
                h('span', null, 'Tự động theo Lux')
              ]),
              h('input', {
                type: 'range', min: 0, max: 100, value: led,
                disabled: autoLed,
                onChange: e => setLed(Number(e.target.value)),
                className: 'w-full'
              }),
              h('div', { className: 'text-sm text-gray-500 mt-2' }, autoLed ? 'Đang tự điều chỉnh' : `Thủ công: ${led}%`),
              h('div', { className: 'mt-4 grid grid-cols-2 gap-2' }, [
                h('div', null, [
                  h('div', { className: 'text-xs text-gray-500 mb-1' }, 'Lux min'),
                  h('input', {
                    type: 'number', value: targetLuxMin, min: 100, max: targetLuxMax - 10,
                    onChange: e => setTargetLuxMin(clamp(Number(e.target.value), 100, targetLuxMax - 10)),
                    className: 'w-full border rounded px-2 py-1'
                  })
                ]),
                h('div', null, [
                  h('div', { className: 'text-xs text-gray-500 mb-1' }, 'Lux max'),
                  h('input', {
                    type: 'number', value: targetLuxMax, min: targetLuxMin + 10, max: 1000,
                    onChange: e => setTargetLuxMax(clamp(Number(e.target.value), targetLuxMin + 10, 1000)),
                    className: 'w-full border rounded px-2 py-1'
                  })
                ])
              ])
            ]),

            // Pomodoro control
            h('div', { className: 'p-4 bg-white rounded-xl border' }, [
              h('div', { className: 'font-semibold mb-2' }, 'Pomodoro'),
              h('div', { className: 'text-4xl font-bold mb-3' }, timeFmt(remain)),
              h('div', { className: 'flex gap-2 mb-3' }, [
                h('button', {
                  className: 'px-3 py-2 rounded-lg border bg-white hover:bg-gray-50',
                  onClick: () => setTimerRunning(r => !r)
                }, timerRunning ? 'Tạm dừng' : 'Tiếp tục'),
                h('button', {
                  className: 'px-3 py-2 rounded-lg border bg-white hover:bg-gray-50',
                  onClick: resetTimer
                }, 'Reset')
              ]),
              h('div', { className: 'grid grid-cols-2 gap-2' }, [
                FieldNumber('Tập trung (phút)', focusMin, v => { setFocusMin(v); if(mode==='focus' && !timerRunning) setRemain(v*60); }),
                FieldNumber('Nghỉ (phút)', breakMin, v => { setBreakMin(v); if(mode==='break' && !timerRunning) setRemain(v*60); })
              ])
            ]),

            // Import/History tools
            h('div', { className: 'p-4 bg-white rounded-xl border' }, [
              h('div', { className: 'font-semibold mb-2' }, 'Dữ liệu'),
              h('div', { className: 'text-sm text-gray-600 mb-3' }, 'Nhập/Xuất để nộp minh chứng KHKT'),
              h('label', { className: 'block' }, [
                h('span', { className: 'text-sm text-gray-500' }, 'Nhập JSON'),
                h('input', { type: 'file', accept: 'application/json', className: 'block mt-1', onChange: e => e.target.files[0] && importData(e.target.files[0]) })
              ]),
              h('button', { className: 'mt-3 px-3 py-2 rounded-lg border bg-white hover:bg-gray-50', onClick: () => setHistory([]) }, 'Xoá lịch sử')
            ])
          ]),

          // Chart
          h('div', { className: 'h-72 md:h-80 bg-white rounded-xl border p-2' }, [
            h('div', { className: 'font-semibold px-2 pb-2' }, 'Biểu đồ cảm biến (120s gần nhất)'),
            h(ResponsiveContainer, { width: '100%', height: '100%' },
              h(LineChart, { data: history }, [
                h(CartesianGrid, { stroke: '#eee', strokeDasharray: '5 5' }),
                h(XAxis, { dataKey: 't', minTickGap: 20 }),
                h(YAxis, null),
                h(Tooltip, null),
                h(Legend, null),
                h(ReferenceLine, { y: targetLuxMin, stroke: '#94a3b8', strokeDasharray: '3 3' }),
                h(ReferenceLine, { y: targetLuxMax, stroke: '#94a3b8', strokeDasharray: '3 3' }),
                h(Line, { type: 'monotone', dataKey: 'lux', stroke: '#10b981', dot: false, name: 'Lux' }),
                h(Line, { type: 'monotone', dataKey: 'temp', stroke: '#3b82f6', dot: false, name: 'Nhiệt độ' }),
                h(Line, { type: 'monotone', dataKey: 'hum', stroke: '#f59e0b', dot: false, name: 'Độ ẩm' }),
                h(Line, { type: 'monotone', dataKey: 'dist', stroke: '#ef4444', dot: false, name: 'Khoảng cách' })
              ])
            )
          ]),

          h('footer', { className: 'text-center text-xs text-gray-500 py-6' }, '© 2025 StudyMate Light – file tổng hợp dùng cho GitHub Pages')
        ]);
      }

      function InfoCard(title, value, hint){
        return h('div', { className: 'p-4 bg-white rounded-xl border' }, [
          h('div', { className: 'text-xs text-gray-500' }, title),
          h('div', { className: 'text-xl font-bold' }, value),
          h('div', { className: 'text-xs text-gray-400' }, hint)
        ]);
      }

      function FieldNumber(label, value, onChange){
        return h('div', null, [
          h('div', { className: 'text-xs text-gray-500 mb-1' }, label),
          h('input', {
            type: 'number', value,
            min: 1, max: 120,
            onChange: e => onChange(clamp(Number(e.target.value), 1, 120)),
            className: 'w-full border rounded px-2 py-1'
          })
        ]);
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(h(App));
    </script>
  </body>
</html>
